/**
 * Universal Business Mini App
 * Telegram Mini Web App for BotFactory AI
 */

// ===== Telegram WebApp SDK =====
const tg = window.Telegram?.WebApp;
let botId = null;

// ===== State =====
const state = {
    business: null,
    catalog: [],
    cart: [],
    filteredCatalog: []
};

// ===== DOM Elements =====
const elements = {};

// ===== Initialization =====
document.addEventListener('DOMContentLoaded', () => {
    initElements();
    initTelegram();
    initTabs();
    initSearch();
    initModals();
    loadData();
});

function initElements() {
    elements.businessLogo = document.getElementById('businessLogo');
    elements.businessName = document.getElementById('businessName');
    elements.businessDescription = document.getElementById('businessDescription');
    elements.catalogGrid = document.getElementById('catalogGrid');
    elements.cartItems = document.getElementById('cartItems');
    elements.cartEmpty = document.getElementById('cartEmpty');
    elements.cartSummary = document.getElementById('cartSummary');
    elements.cartTotal = document.getElementById('cartTotal');
    elements.cartBadge = document.getElementById('cartBadge');
    elements.orderBar = document.getElementById('orderBar');
    elements.orderCount = document.getElementById('orderCount');
    elements.orderTotal = document.getElementById('orderTotal');
    elements.orderButton = document.getElementById('orderButton');
    elements.orderModal = document.getElementById('orderModal');
    elements.orderForm = document.getElementById('orderForm');
    elements.itemModal = document.getElementById('itemModal');
    elements.loading = document.getElementById('loading');
    elements.toast = document.getElementById('toast');
    elements.searchInput = document.getElementById('searchInput');
    elements.contactPhone = document.getElementById('contactPhone');
    elements.contactAddress = document.getElementById('contactAddress');
    elements.contactHours = document.getElementById('contactHours');
    elements.callButton = document.getElementById('callButton');
}

function initTelegram() {
    if (tg) {
        tg.ready();
        tg.expand();

        // Apply Telegram theme
        if (tg.colorScheme === 'light') {
            document.body.classList.add('light-theme');
        }

        // Get bot_id from start parameter
        const startParam = tg.initDataUnsafe?.start_param;
        if (startParam) {
            botId = startParam;
        }

        // Set header color
        tg.setHeaderColor('#1a1a1a');
        tg.setBackgroundColor('#0f0f0f');
    }

    // Fallback: get bot_id from URL
    if (!botId) {
        const urlParams = new URLSearchParams(window.location.search);
        botId = urlParams.get('bot_id') || '1';
    }
}

function initTabs() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            switchTab(tabName);
        });
    });
}

function switchTab(tabName) {
    // Update tabs
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Update sections
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(`${tabName}Section`).classList.add('active');
}

function initSearch() {
    elements.searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        if (query) {
            state.filteredCatalog = state.catalog.filter(item =>
                item.name.toLowerCase().includes(query) ||
                (item.description && item.description.toLowerCase().includes(query))
            );
        } else {
            state.filteredCatalog = [...state.catalog];
        }
        renderCatalog();
    });
}

function initModals() {
    // Order modal
    document.getElementById('closeModal').addEventListener('click', () => {
        elements.orderModal.classList.add('hidden');
    });

    elements.orderButton.addEventListener('click', openOrderModal);
    elements.orderForm.addEventListener('submit', submitOrder);

    // Item modal
    document.getElementById('closeItemModal').addEventListener('click', () => {
        elements.itemModal.classList.add('hidden');
    });

    // Quantity controls
    let currentItem = null;
    let currentQty = 1;

    document.getElementById('qtyMinus').addEventListener('click', () => {
        if (currentQty > 1) {
            currentQty--;
            document.getElementById('qtyValue').textContent = currentQty;
        }
    });

    document.getElementById('qtyPlus').addEventListener('click', () => {
        if (currentQty < 99) {
            currentQty++;
            document.getElementById('qtyValue').textContent = currentQty;
        }
    });

    document.getElementById('addToCartBtn').addEventListener('click', () => {
        if (currentItem) {
            addToCart(currentItem, currentQty);
            elements.itemModal.classList.add('hidden');
            currentQty = 1;
            document.getElementById('qtyValue').textContent = '1';
        }
    });

    // Store reference for item modal
    window.openItemModal = (item) => {
        currentItem = item;
        currentQty = 1;
        document.getElementById('qtyValue').textContent = '1';

        document.getElementById('itemModalImage').src = item.image || '/static/images/placeholder.png';
        document.getElementById('itemModalName').textContent = item.name;
        document.getElementById('itemModalDescription').textContent = item.description || '';
        document.getElementById('itemModalPrice').textContent = formatPrice(item.price);

        elements.itemModal.classList.remove('hidden');
    };
}

// ===== Data Loading =====
async function loadData() {
    showLoading();
    try {
        // Load business info
        const businessRes = await fetch(`/api/miniapp/business/${botId}`);
        if (businessRes.ok) {
            state.business = await businessRes.json();
            renderBusiness();
        }

        // Load catalog
        const catalogRes = await fetch(`/api/miniapp/catalog/${botId}`);
        if (catalogRes.ok) {
            state.catalog = await catalogRes.json();
            state.filteredCatalog = [...state.catalog];
            renderCatalog();
        }

        // Load contact
        const contactRes = await fetch(`/api/miniapp/contact/${botId}`);
        if (contactRes.ok) {
            const contact = await contactRes.json();
            renderContact(contact);
        }
    } catch (error) {
        console.error('Error loading data:', error);
        showToast('Ma\'lumotlarni yuklashda xatolik');
    } finally {
        hideLoading();
    }
}

// ===== Rendering =====
function renderBusiness() {
    if (!state.business) return;

    elements.businessName.textContent = state.business.name || 'Biznes';
    elements.businessDescription.textContent = state.business.description || '';

    if (state.business.logo) {
        elements.businessLogo.src = state.business.logo;
    } else {
        elements.businessLogo.src = '/static/images/default-logo.png';
    }
}

function renderCatalog() {
    const items = state.filteredCatalog;

    if (items.length === 0) {
        elements.catalogGrid.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
                <span class="empty-icon">üì¶</span>
                <p>Mahsulotlar topilmadi</p>
            </div>
        `;
        return;
    }

    elements.catalogGrid.innerHTML = items.map(item => `
        <div class="catalog-item" onclick="openItemModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
            <img class="item-image" src="${item.image || '/static/images/placeholder.png'}" alt="${item.name}" onerror="this.src='/static/images/placeholder.png'">
            <div class="item-info">
                <div class="item-name">${item.name}</div>
                <div class="item-price">${formatPrice(item.price)}</div>
            </div>
        </div>
    `).join('');
}

function renderContact(contact) {
    elements.contactPhone.textContent = contact.phone || 'Ko\'rsatilmagan';
    elements.contactAddress.textContent = contact.address || 'Ko\'rsatilmagan';
    elements.contactHours.textContent = contact.working_hours || 'Ko\'rsatilmagan';

    if (contact.phone) {
        elements.callButton.href = `tel:${contact.phone}`;
    }
}

function renderCart() {
    if (state.cart.length === 0) {
        elements.cartItems.innerHTML = '';
        elements.cartEmpty.classList.remove('hidden');
        elements.cartSummary.classList.add('hidden');
        elements.orderBar.classList.add('hidden');
        return;
    }

    elements.cartEmpty.classList.add('hidden');
    elements.cartSummary.classList.remove('hidden');
    elements.orderBar.classList.remove('hidden');

    elements.cartItems.innerHTML = state.cart.map((item, index) => `
        <div class="cart-item">
            <img class="cart-item-image" src="${item.image || '/static/images/placeholder.png'}" alt="${item.name}">
            <div class="cart-item-info">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">${formatPrice(item.price)}</div>
                <div class="cart-item-actions">
                    <div class="quantity-control">
                        <button class="qty-btn" onclick="updateCartQty(${index}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="qty-btn" onclick="updateCartQty(${index}, 1)">+</button>
                    </div>
                    <button class="remove-btn" onclick="removeFromCart(${index})">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');

    updateCartSummary();
}

function updateCartSummary() {
    const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const count = state.cart.reduce((sum, item) => sum + item.quantity, 0);

    elements.cartTotal.textContent = formatPrice(total);
    elements.orderCount.textContent = `${count} ta`;
    elements.orderTotal.textContent = formatPrice(total);

    // Update badge
    if (count > 0) {
        elements.cartBadge.textContent = count;
        elements.cartBadge.classList.remove('hidden');
    } else {
        elements.cartBadge.classList.add('hidden');
    }
}

// ===== Cart Operations =====
function addToCart(item, quantity = 1) {
    const existingIndex = state.cart.findIndex(i => i.id === item.id);

    if (existingIndex >= 0) {
        state.cart[existingIndex].quantity += quantity;
    } else {
        state.cart.push({
            ...item,
            quantity: quantity
        });
    }

    renderCart();
    showToast(`${item.name} savatga qo'shildi`);
}

window.updateCartQty = function (index, delta) {
    if (state.cart[index]) {
        state.cart[index].quantity += delta;
        if (state.cart[index].quantity <= 0) {
            state.cart.splice(index, 1);
        }
        renderCart();
    }
};

window.removeFromCart = function (index) {
    state.cart.splice(index, 1);
    renderCart();
};

// ===== Order =====
function openOrderModal() {
    if (state.cart.length === 0) return;

    // Pre-fill from Telegram user data
    if (tg && tg.initDataUnsafe?.user) {
        const user = tg.initDataUnsafe.user;
        document.getElementById('customerName').value = `${user.first_name || ''} ${user.last_name || ''}`.trim();
    }

    // Render order items
    document.getElementById('modalOrderItems').innerHTML = state.cart.map(item => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span>${item.name} x${item.quantity}</span>
            <span>${formatPrice(item.price * item.quantity)}</span>
        </div>
    `).join('');

    const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('modalTotal').textContent = formatPrice(total);

    elements.orderModal.classList.remove('hidden');
}

async function submitOrder(e) {
    e.preventDefault();

    const orderData = {
        bot_id: botId,
        customer_name: document.getElementById('customerName').value,
        customer_phone: document.getElementById('customerPhone').value,
        customer_address: document.getElementById('customerAddress').value,
        note: document.getElementById('orderNote').value,
        items: state.cart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity
        })),
        total: state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
        telegram_user_id: tg?.initDataUnsafe?.user?.id || null
    };

    showLoading();

    try {
        const response = await fetch('/api/miniapp/order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
        });

        if (response.ok) {
            // Clear cart
            state.cart = [];
            renderCart();

            // Close modal
            elements.orderModal.classList.add('hidden');

            // Show success
            showToast('‚úÖ Buyurtma qabul qilindi!');

            // Send data to Telegram
            if (tg) {
                tg.sendData(JSON.stringify({
                    type: 'order',
                    success: true,
                    order_id: (await response.json()).order_id
                }));
            }
        } else {
            const error = await response.json();
            showToast(`‚ùå Xatolik: ${error.message || 'Buyurtma yuborilmadi'}`);
        }
    } catch (error) {
        console.error('Order error:', error);
        showToast('‚ùå Tarmoq xatosi');
    } finally {
        hideLoading();
    }
}

// ===== Utilities =====
function formatPrice(price) {
    if (!price) return '0 so\'m';
    return Number(price).toLocaleString('uz-UZ') + ' so\'m';
}

function showLoading() {
    elements.loading.classList.remove('hidden');
}

function hideLoading() {
    elements.loading.classList.add('hidden');
}

function showToast(message) {
    elements.toast.textContent = message;
    elements.toast.classList.remove('hidden');

    setTimeout(() => {
        elements.toast.classList.add('hidden');
    }, 3000);
}
